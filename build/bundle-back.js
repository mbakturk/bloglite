!function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=13)}([function(module,exports){module.exports=require("inversify")},function(module,exports){module.exports=require("reflect-metadata")},function(module,exports,__webpack_require__){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(__webpack_require__(18)),__export(__webpack_require__(10)),__export(__webpack_require__(19)),__export(__webpack_require__(21))},function(module,exports){module.exports=require("inversify-express-utils")},function(module,exports){module.exports=require("rxjs")},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__metadata=this&&this.__metadata||function(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)};Object.defineProperty(exports,"__esModule",{value:!0});const inversify_1=__webpack_require__(0);__webpack_require__(1);const database_1=__webpack_require__(8),operators_1=__webpack_require__(6);let PostDAO=class{getPostList(count,offset){return this.db.queryAll("SELECT p.id, p.title, p.permalink, p.post_date as postDate, p.entry, u.id as authorId, u.name as authorName \n        FROM t_post as p LEFT JOIN t_user u ON p.author == u.id ORDER BY p.post_date DESC LIMIT ? OFFSET ?",[count,offset])}getPostLiteList(count,offset){return this.db.queryAll("SELECT p.id, p.title, p.permalink, p.post_date as postDate, u.name as authorName \n        FROM t_post as p LEFT JOIN t_user u ON p.author == u.id ORDER BY p.post_date DESC LIMIT ? OFFSET ?",[count,offset])}createPost(title,permalink,entry,authorId){return this.db.run("INSERT INTO t_post (title, permalink, entry, author) VALUES (?,?,?,?)",[title,permalink,entry,authorId]).pipe(operators_1.map(data=>data.lastID))}deletePostById(id){return this.db.run("DELETE FROM t_post WHERE id = ?",[id])}updatePost(post){let updates=[];const values=[];return["title","permalink","entry"].forEach(property=>{const value=post[property];value&&(updates.push(`${property} = ?`),values.push(value))}),values.push(post.id),this.db.run(`UPDATE t_post SET ${updates.join(",")} WHERE id = ?`,values)}getPostByPermalink(permalink){return this.db.query("SELECT p.id, p.title, p.permalink, p.post_date as postDate, p.entry, u.id as authorId, u.name as authorName \n             FROM t_post as p LEFT JOIN t_user u ON p.author == u.id WHERE p.permalink = ?",[permalink])}getPostById(id){return this.db.query("SELECT p.id, p.title, p.permalink, p.post_date as postDate, p.entry, u.id as authorId, u.name as authorName \n             FROM t_post as p LEFT JOIN t_user u ON p.author == u.id WHERE p.id = ?",[id])}getPostCount(){return this.db.query("SELECT value FROM t_metadata WHERE key = 't_post_count'").pipe(operators_1.map(row=>{const count=+row.value;return Number.isInteger(count)?count:0}))}isPermalinkExist(permalink){return this.db.query("SELECT permalink FROM t_post WHERE permalink = ?",[permalink]).pipe(operators_1.map(row=>!!row))}};__decorate([inversify_1.inject(database_1.Database),__metadata("design:type",database_1.Database)],PostDAO.prototype,"db",void 0),PostDAO=__decorate([inversify_1.injectable()],PostDAO),exports.PostDAO=PostDAO},function(module,exports){module.exports=require("rxjs/operators")},function(module,exports){module.exports=require("path")},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__metadata=this&&this.__metadata||function(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};Object.defineProperty(exports,"__esModule",{value:!0});const inversify_1=__webpack_require__(0),sqlite3_1=__webpack_require__(23),rxjs_1=__webpack_require__(4);let Database=class{constructor(config){this.config=config,this.db=new sqlite3_1.Database(this.config.database.path,err=>{if(err)return this.logger.error(`An error accoured while connection database. Error stack is ${err.stack}`);this.logger.debug("Database connection is successful.")})}queryAll(queryString,values){return this._query("all",queryString,values)}query(queryString,values){return this._query("get",queryString,values)}run(queryString,values){return this._query("run",queryString,values)}_query(method,queryString,values){return rxjs_1.Observable.create(observer=>{this.db[method](queryString,values,(err,data)=>{err?(this.logger.error(`An error accoured while querying db. Error stack it ${err.stack}`),observer.error(err)):observer.next("run"===method?this:data),observer.complete()})})}};__decorate([inversify_1.inject("Logger"),__metadata("design:type",Object)],Database.prototype,"logger",void 0),Database=__decorate([inversify_1.injectable(),__param(0,inversify_1.inject("Config")),__metadata("design:paramtypes",[Object])],Database),exports.Database=Database},function(module,exports){module.exports=require("fs")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const rxjs_1=__webpack_require__(4);exports.SessionUtils=class{static saveSession(session){return rxjs_1.Observable.create(observer=>{session.save(err=>{err?observer.error(err):observer.next(!0)}),observer.complete()})}}},function(module,exports){module.exports=require("express")},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__metadata=this&&this.__metadata||function(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)};Object.defineProperty(exports,"__esModule",{value:!0});const inversify_1=__webpack_require__(0);__webpack_require__(1);const database_1=__webpack_require__(8);let UserDAO=class{getUserList(){return this.db.queryAll("SELECT * FROM t_user")}getUserByEmail(email){return this.db.query("SELECT * FROM t_user WHERE email = ?",[email])}getUserById(id){return this.db.query("SELECT * FROM t_user WHERE id = ?",[id])}};__decorate([inversify_1.inject(database_1.Database),__metadata("design:type",database_1.Database)],UserDAO.prototype,"db",void 0),UserDAO=__decorate([inversify_1.injectable()],UserDAO),exports.UserDAO=UserDAO},function(module,exports,__webpack_require__){module.exports=__webpack_require__(14)},function(module,exports,__webpack_require__){"use strict";(function(__dirname){Object.defineProperty(exports,"__esModule",{value:!0}),__webpack_require__(1);const request_handler_utils_1=__webpack_require__(15),di_container_1=__webpack_require__(16),inversify_express_utils_1=__webpack_require__(3),bodyParser=__webpack_require__(33),path=__webpack_require__(7),fs=__webpack_require__(9),express=__webpack_require__(11),session=__webpack_require__(34),utils_1=__webpack_require__(2),SessionStore=__webpack_require__(35)(session),config=di_container_1.container.get("Config"),logger=di_container_1.container.get("Logger");[path.join(process.cwd(),config.log.path)].forEach(dir=>{fs.existsSync(dir)||fs.mkdirSync(dir)});let server=new inversify_express_utils_1.InversifyExpressServer(di_container_1.container);server.setConfig(app=>{app.use(bodyParser.urlencoded({extended:!0,limit:"50mb"})),app.use(bodyParser.json()),app.use(logger.handleExpressLogs.bind(logger)),app.use(express.static(path.join(__dirname,"../public"))),app.set("views",path.join(__dirname,"../views")),app.set("view engine","pug"),app.use(session({store:new SessionStore({db:config.database.path,table:"t_sessions"}),secret:config.sessionScreet,resave:!0,saveUninitialized:!1,cookie:{maxAge:6048e5}})),app.use(utils_1.SecurityUtils.checkReqAuth)});let app=server.build();app.use(request_handler_utils_1.RequestHandlerUtils.handle404),app.use(request_handler_utils_1.RequestHandlerUtils.handle500),app.listen(config.server.port),logger.info("Bloglite is running!")}).call(this,"dist")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.RequestHandlerUtils=class{static handle404(req,res,next){res.status(404),res.render("404")}static handle500(err,req,res,next){if(res.headersSent)return next(err);res.status(500),res.render("500")}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const inversify_1=__webpack_require__(0),config_reader_1=__webpack_require__(17),dashboard_controller_1=__webpack_require__(22),editor_controller_1=__webpack_require__(24),login_controller_1=__webpack_require__(25),post_controller_1=__webpack_require__(26),rss_controller_1=__webpack_require__(28),database_1=__webpack_require__(8),logger_1=__webpack_require__(30),post_dao_1=__webpack_require__(5),user_dao_1=__webpack_require__(12),container=new inversify_1.Container;exports.container=container,container.bind("Config").toConstantValue(config_reader_1.config),container.bind("Logger").toConstantValue(logger_1.LoggerCreator(container)),container.bind(database_1.Database).toSelf().inSingletonScope(),container.bind(user_dao_1.UserDAO).toSelf().inSingletonScope(),container.bind(post_dao_1.PostDAO).toSelf().inSingletonScope(),container.bind(login_controller_1.LoginController).toSelf(),container.bind(dashboard_controller_1.DashboardController).toSelf(),container.bind(editor_controller_1.EditorController).toSelf(),container.bind(post_controller_1.PostController).toSelf(),container.bind(rss_controller_1.RSSController).toSelf()},function(module,exports,__webpack_require__){"use strict";(function(__dirname){Object.defineProperty(exports,"__esModule",{value:!0});const path=__webpack_require__(7),fs=__webpack_require__(9),utils_1=__webpack_require__(2);exports.config=(()=>{const filePath=path.join(__dirname,"../config.json");console.log("Config file's path is "+__dirname);const config=JSON.parse(fs.readFileSync(filePath,"utf8"));return utils_1.DateUtils.timezone=config.timezone,utils_1.SecurityUtils.securePath="/"+config.securePath,config})()}).call(this,"dist")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class CommonUtils{static generatePermalink(text){const specialCharDictionary={"ş":"s","ı":"i","ğ":"g","ö":"o","ç":"c","ü":"u"};let permalink=text.toLocaleLowerCase();return Object.keys(specialCharDictionary).forEach(key=>{permalink=CommonUtils.replaceAll(permalink,key,specialCharDictionary[key])}),permalink=permalink.replace(/\W/g," ").replace(/\s+/g," ").trim().replace(/\s+/g,"-")}static replaceAll(target,search,replacement){return target.replace(new RegExp(search,"g"),replacement)}}exports.CommonUtils=CommonUtils},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const moment=__webpack_require__(20);class DateUtils{static now(){return moment().tz(DateUtils.timezone)}}exports.DateUtils=DateUtils},function(module,exports){module.exports=require("moment-timezone")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const hallPassAPIs=["login"];class SecurityUtils{static checkReqAuth(req,res,next){0!==req.url.indexOf(SecurityUtils.securePath+"/")||hallPassAPIs.find(path=>req.url.includes(path))||req.session&&req.session.user?next():res.redirect(SecurityUtils.securePath)}}SecurityUtils.securePath="/s",exports.SecurityUtils=SecurityUtils},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__metadata=this&&this.__metadata||function(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};Object.defineProperty(exports,"__esModule",{value:!0});const post_dao_1=__webpack_require__(5);__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3),inversify_1=__webpack_require__(0),operators_1=(__webpack_require__(11),__webpack_require__(6)),utils_1=__webpack_require__(2);let DashboardController=class{constructor(){this.PAGE_SIZE=10}dashboardPage(page,res){let mPage=0;return page&&(mPage=+page-1),this.postDAO.getPostLiteList(this.PAGE_SIZE,this.PAGE_SIZE*mPage).pipe(operators_1.switchMap(postList=>this.postDAO.getPostCount().pipe(operators_1.map(c=>({totalPage:Math.ceil(c/this.PAGE_SIZE),postList:postList}))))).toPromise().then(r=>{res.render("dashboard",{postList:r.postList,pageNum:mPage+1,totalPage:0===r.totalPage?1:r.totalPage})})}};__decorate([inversify_1.inject(post_dao_1.PostDAO),__metadata("design:type",post_dao_1.PostDAO)],DashboardController.prototype,"postDAO",void 0),__decorate([inversify_express_utils_1.httpGet("/dashboard"),__param(0,inversify_express_utils_1.queryParam("page")),__param(1,inversify_express_utils_1.response()),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],DashboardController.prototype,"dashboardPage",null),DashboardController=__decorate([inversify_express_utils_1.controller(utils_1.SecurityUtils.securePath)],DashboardController),exports.DashboardController=DashboardController},function(module,exports){module.exports=require("sqlite3")},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__metadata=this&&this.__metadata||function(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};Object.defineProperty(exports,"__esModule",{value:!0});const post_dao_1=__webpack_require__(5);__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3),inversify_1=__webpack_require__(0),operators_1=__webpack_require__(6),utils_1=__webpack_require__(2),rxjs_1=__webpack_require__(4);let EditorController=class{editorPage(postId,res){return this.postDAO.getPostById(+postId).pipe(operators_1.map(post=>({post:post}))).toPromise().then(viewModel=>res.render("editor",viewModel))}updatePost(req,res){const resp={retCode:-1},post=req.body;if(post)return this.postDAO.updatePost(post).toPromise().then(r=>{resp.retCode=0,res.json(resp)});res.json(resp)}createPost(req,res){const resp={retCode:-1},post=req.body;if(post)return this.postDAO.createPost(post.title,post.permalink,post.entry,req.session.user.id).toPromise().then(r=>{resp.retCode=0,res.json(resp)});res.json(resp)}deletePost(req,res){const resp={retCode:-1},postId=req.body?+req.body.id:null;if(postId)return this.postDAO.deletePostById(postId).toPromise().then(r=>{resp.retCode=0,res.json(resp)});res.json(resp)}getPermalink(req,res){let permalink=req.body.permalink||"";if(permalink){permalink=utils_1.CommonUtils.generatePermalink(permalink);let counter=0,suffix="";return rxjs_1.Observable.create(observer=>{const checkPermalink=p=>{p+=suffix,this.postDAO.isPermalinkExist(p).subscribe(r=>{r?(suffix+="-"+counter++,checkPermalink(permalink)):(observer.next(permalink),observer.complete())},e=>{observer.error(e),observer.complete()})};checkPermalink(permalink)}).toPromise().then(r=>res.json({retCode:0,retMsg:"Success",permalink:permalink})).catch(err=>res.json({retCode:1,retMsg:"Generating permalink error"}))}return res.json({retCode:-1,retMsg:"Input error"})}};__decorate([inversify_1.inject(post_dao_1.PostDAO),__metadata("design:type",post_dao_1.PostDAO)],EditorController.prototype,"postDAO",void 0),__decorate([inversify_express_utils_1.httpGet("/editor"),__param(0,inversify_express_utils_1.queryParam("post")),__param(1,inversify_express_utils_1.response()),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"editorPage",null),__decorate([inversify_express_utils_1.httpPost("/updatePost"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"updatePost",null),__decorate([inversify_express_utils_1.httpPost("/createPost"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"createPost",null),__decorate([inversify_express_utils_1.httpPost("/deletePost"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"deletePost",null),__decorate([inversify_express_utils_1.httpPost("/getPermalink"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"getPermalink",null),EditorController=__decorate([inversify_express_utils_1.controller(utils_1.SecurityUtils.securePath)],EditorController),exports.EditorController=EditorController},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__metadata=this&&this.__metadata||function(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)};Object.defineProperty(exports,"__esModule",{value:!0});const session_utils_1=__webpack_require__(10),user_dao_1=__webpack_require__(12);__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3),inversify_1=__webpack_require__(0),operators_1=__webpack_require__(6),rxjs_1=__webpack_require__(4),utils_1=__webpack_require__(2);let LoginController=class{loginPage(req,res,next){req.session.user?res.redirect(utils_1.SecurityUtils.securePath+"/dashboard"):res.render("login")}authenticate(req,res,next){if(req.body.email)return this.userDAO.getUserByEmail(req.body.email).pipe(operators_1.switchMap(user=>user&&user.password===req.body.password?(req.session.user=user,session_utils_1.SessionUtils.saveSession(req.session)):rxjs_1.of(!1))).toPromise().then(isSuccess=>{isSuccess?res.redirect(utils_1.SecurityUtils.securePath+"/dashboard"):res.redirect(utils_1.SecurityUtils.securePath)});res.redirect(utils_1.SecurityUtils.securePath)}};__decorate([inversify_1.inject(user_dao_1.UserDAO),__metadata("design:type",user_dao_1.UserDAO)],LoginController.prototype,"userDAO",void 0),__decorate([inversify_express_utils_1.httpGet("/"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object,Function]),__metadata("design:returntype",void 0)],LoginController.prototype,"loginPage",null),__decorate([inversify_express_utils_1.httpPost("/"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object,Function]),__metadata("design:returntype",void 0)],LoginController.prototype,"authenticate",null),LoginController=__decorate([inversify_express_utils_1.controller(utils_1.SecurityUtils.securePath)],LoginController),exports.LoginController=LoginController},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__metadata=this&&this.__metadata||function(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};Object.defineProperty(exports,"__esModule",{value:!0});const error_404_1=__webpack_require__(27),operators_1=__webpack_require__(6),post_dao_1=__webpack_require__(5);__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3),inversify_1=__webpack_require__(0),rxjs_1=__webpack_require__(4);let PostController=class{constructor(){this.PAGE_SIZE=10}homePage(page,res){let mPage=0;return page&&(mPage=+page-1),rxjs_1.zip(this.postDAO.getPostList(this.PAGE_SIZE,this.PAGE_SIZE*mPage),this.postDAO.getPostCount()).pipe(operators_1.map(d=>({postList:d[0],totalPage:Math.ceil(d[1]/this.PAGE_SIZE)}))).toPromise().then(r=>{res.render("home",{postList:r.postList,pageNum:mPage+1,totalPage:r.totalPage})})}postPage(permalink,res){return this.postDAO.getPostByPermalink(permalink).pipe(operators_1.map(post=>{if(post)return post;throw new error_404_1.Error404("Page not found")})).toPromise().then(post=>{res.render("post",{post:post})}).catch(err=>{err instanceof error_404_1.Error404&&(res.status(404),res.render("404"))})}};__decorate([inversify_1.inject(post_dao_1.PostDAO),__metadata("design:type",post_dao_1.PostDAO)],PostController.prototype,"postDAO",void 0),__decorate([inversify_express_utils_1.httpGet("/"),__param(0,inversify_express_utils_1.queryParam("page")),__param(1,inversify_express_utils_1.response()),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],PostController.prototype,"homePage",null),__decorate([inversify_express_utils_1.httpGet("p/:permalink"),__param(0,inversify_express_utils_1.requestParam("permalink")),__param(1,inversify_express_utils_1.response()),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],PostController.prototype,"postPage",null),PostController=__decorate([inversify_express_utils_1.controller("/")],PostController),exports.PostController=PostController},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.Error404=class extends Error{constructor(msg){super(msg)}}},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__metadata=this&&this.__metadata||function(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)};Object.defineProperty(exports,"__esModule",{value:!0}),__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3),RSS=__webpack_require__(29),post_dao_1=__webpack_require__(5),inversify_1=__webpack_require__(0);let RSSController=class{rss(req,res){const feed=new RSS({title:"mbakturk.com",description:"Yazılım Mühendisi / Kişisel Blog Sitesi",site_url:this.config.baseUrl,feed_url:this.config.baseUrl+"/rss",language:"tr"});return this.postDAO.getPostList(100,0).toPromise().then(postList=>{postList.forEach(post=>{feed.item({title:post.title,description:this.generateRSSDescription(post.entry),url:`${this.config.baseUrl}/p/${post.permalink}`,date:post.postDate})}),res.set("Content-Type","text/xml"),res.send(feed.xml({indent:!0}))})}generateRSSDescription(text){return text?text.replace(/<\/?[^>]+(>|$)/g," ").substr(0,250).trim()+"...":""}};__decorate([inversify_1.inject(post_dao_1.PostDAO),__metadata("design:type",post_dao_1.PostDAO)],RSSController.prototype,"postDAO",void 0),__decorate([inversify_1.inject("Config"),__metadata("design:type",Object)],RSSController.prototype,"config",void 0),__decorate([inversify_express_utils_1.httpGet("rss"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],RSSController.prototype,"rss",null),RSSController=__decorate([inversify_express_utils_1.controller("/")],RSSController),exports.RSSController=RSSController},function(module,exports){module.exports=require("rss")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const winston_1=__webpack_require__(31),path=__webpack_require__(7),DailyRotateFile=__webpack_require__(32),utils_1=__webpack_require__(2);exports.LoggerCreator=(container=>{const config=container.get("Config"),logDir=path.join(process.cwd(),config.log.path),timestamp=winston_1.format((info,opts)=>(info.timestamp=utils_1.DateUtils.now().format("YYYY-MM-DD HH:mm:ss"),info)),logFormat=winston_1.format.combine(timestamp(),winston_1.format.printf(info=>`${info.timestamp} [${info.level}]: ${info.message}`)),errorTransport=new DailyRotateFile({filename:logDir+"error-%DATE%.log",datePattern:"YYYY-MM-DD",maxSize:"20m",level:"error"}),combinedTransport=new DailyRotateFile({filename:logDir+"combined-%DATE%.log",datePattern:"YYYY-MM-DD",maxSize:"20m"}),logger=winston_1.createLogger({level:config.log.level,format:logFormat,transports:[errorTransport,combinedTransport,new winston_1.transports.Console({level:"info"})]});return logger.handleExpressLogs=((req,res,next)=>{const ip=req.connection.remoteAddress;logger.debug(`(${ip}) ${req.method} ${req.url} ${res.statusCode}`),next()}),logger})},function(module,exports){module.exports=require("winston")},function(module,exports){module.exports=require("winston-daily-rotate-file")},function(module,exports){module.exports=require("body-parser")},function(module,exports){module.exports=require("express-session")},function(module,exports){module.exports=require("connect-sqlite3")}]);