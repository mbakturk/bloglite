(function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{enumerable:true,get:getter})}};__webpack_require__.r=function(exports){if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(exports,"__esModule",{value:true})};__webpack_require__.t=function(value,mode){if(mode&1)value=__webpack_require__(value);if(mode&8)return value;if(mode&4&&typeof value==="object"&&value&&value.__esModule)return value;var ns=Object.create(null);__webpack_require__.r(ns);Object.defineProperty(ns,"default",{enumerable:true,value:value});if(mode&2&&typeof value!="string")for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module["default"]}:function getModuleExports(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=13)})([function(module,exports){module.exports=require("inversify")},function(module,exports){module.exports=require("reflect-metadata")},function(module,exports,__webpack_require__){"use strict";function __export(m){for(var p in m)if(!exports.hasOwnProperty(p))exports[p]=m[p]}Object.defineProperty(exports,"__esModule",{value:true});__export(__webpack_require__(18));__export(__webpack_require__(10));__export(__webpack_require__(19));__export(__webpack_require__(21))},function(module,exports){module.exports=require("inversify-express-utils")},function(module,exports){module.exports=require("rxjs")},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};Object.defineProperty(exports,"__esModule",{value:true});const inversify_1=__webpack_require__(0);__webpack_require__(1);const database_1=__webpack_require__(8);const operators_1=__webpack_require__(6);let PostDAO=class PostDAO{getPostList(count,offset){return this.db.queryAll(`SELECT p.id, p.title, p.permalink, p.post_date as postDate, p.entry, u.id as authorId, u.name as authorName \n        FROM t_post as p LEFT JOIN t_user u ON p.author == u.id ORDER BY p.post_date DESC LIMIT ? OFFSET ?`,[count,offset])}getPostLiteList(count,offset){return this.db.queryAll(`SELECT p.id, p.title, p.permalink, p.post_date as postDate, u.name as authorName \n        FROM t_post as p LEFT JOIN t_user u ON p.author == u.id ORDER BY p.post_date DESC LIMIT ? OFFSET ?`,[count,offset])}createPost(title,permalink,entry,authorId){return this.db.run("INSERT INTO t_post (title, permalink, entry, author) VALUES (?,?,?,?)",[title,permalink,entry,authorId]).pipe(operators_1.map(data=>data.lastID))}deletePostById(id){return this.db.run(`DELETE FROM t_post WHERE id = ?`,[id])}updatePost(post){const updateables=["title","permalink","entry"];let updates=[];const values=[];updateables.forEach(property=>{const value=post[property];if(value){updates.push(`${property} = ?`);values.push(value)}});values.push(post.id);return this.db.run(`UPDATE t_post SET ${updates.join(",")} WHERE id = ?`,values)}getPostByPermalink(permalink){return this.db.query(`SELECT p.id, p.title, p.permalink, p.post_date as postDate, p.entry, u.id as authorId, u.name as authorName \n             FROM t_post as p LEFT JOIN t_user u ON p.author == u.id WHERE p.permalink = ?`,[permalink])}getPostById(id){return this.db.query(`SELECT p.id, p.title, p.permalink, p.post_date as postDate, p.entry, u.id as authorId, u.name as authorName \n             FROM t_post as p LEFT JOIN t_user u ON p.author == u.id WHERE p.id = ?`,[id])}getPostCount(){return this.db.query(`SELECT value FROM t_metadata WHERE key = 't_post_count'`).pipe(operators_1.map(row=>{const count=+row.value;return Number.isInteger(count)?count:0}))}isPermalinkExist(permalink){return this.db.query("SELECT permalink FROM t_post WHERE permalink = ?",[permalink]).pipe(operators_1.map(row=>{if(row){return true}else{return false}}))}};__decorate([inversify_1.inject(database_1.Database),__metadata("design:type",database_1.Database)],PostDAO.prototype,"db",void 0);PostDAO=__decorate([inversify_1.injectable()],PostDAO);exports.PostDAO=PostDAO},function(module,exports){module.exports=require("rxjs/operators")},function(module,exports){module.exports=require("path")},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};var __param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};Object.defineProperty(exports,"__esModule",{value:true});const inversify_1=__webpack_require__(0);const sqlite3_1=__webpack_require__(23);const rxjs_1=__webpack_require__(4);let Database=class Database{constructor(config){this.config=config;this.db=new sqlite3_1.Database(this.config.database.path,err=>{if(err){return this.logger.error(`An error accoured while connection database. Error stack is ${err.stack}`)}this.logger.debug("Database connection is successful.")})}queryAll(queryString,values){return this._query("all",queryString,values)}query(queryString,values){return this._query("get",queryString,values)}run(queryString,values){return this._query("run",queryString,values)}_query(method,queryString,values){return rxjs_1.Observable.create(observer=>{this.db[method](queryString,values,(err,data)=>{if(err){this.logger.error(`An error accoured while querying db. Error stack it ${err.stack}`);observer.error(err)}else{observer.next(method==="run"?this:data)}observer.complete()})})}};__decorate([inversify_1.inject("Logger"),__metadata("design:type",Object)],Database.prototype,"logger",void 0);Database=__decorate([inversify_1.injectable(),__param(0,inversify_1.inject("Config")),__metadata("design:paramtypes",[Object])],Database);exports.Database=Database},function(module,exports){module.exports=require("fs")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const rxjs_1=__webpack_require__(4);class SessionUtils{static saveSession(session){return rxjs_1.Observable.create(observer=>{session.save(err=>{if(err){observer.error(err)}else{observer.next(true)}});observer.complete()})}}exports.SessionUtils=SessionUtils},function(module,exports){module.exports=require("express")},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};Object.defineProperty(exports,"__esModule",{value:true});const inversify_1=__webpack_require__(0);__webpack_require__(1);const database_1=__webpack_require__(8);let UserDAO=class UserDAO{getUserList(){return this.db.queryAll("SELECT * FROM t_user")}getUserByEmail(email){return this.db.query("SELECT * FROM t_user WHERE email = ?",[email])}getUserById(id){return this.db.query("SELECT * FROM t_user WHERE id = ?",[id])}};__decorate([inversify_1.inject(database_1.Database),__metadata("design:type",database_1.Database)],UserDAO.prototype,"db",void 0);UserDAO=__decorate([inversify_1.injectable()],UserDAO);exports.UserDAO=UserDAO},function(module,exports,__webpack_require__){module.exports=__webpack_require__(14)},function(module,exports,__webpack_require__){"use strict";(function(__dirname){Object.defineProperty(exports,"__esModule",{value:true});__webpack_require__(1);const request_handler_utils_1=__webpack_require__(15);const di_container_1=__webpack_require__(16);const inversify_express_utils_1=__webpack_require__(3);const bodyParser=__webpack_require__(33);const path=__webpack_require__(7);const fs=__webpack_require__(9);const express=__webpack_require__(11);const session=__webpack_require__(34);const utils_1=__webpack_require__(2);const SessionStore=__webpack_require__(35)(session);const config=di_container_1.container.get("Config");const logger=di_container_1.container.get("Logger");[path.join(process.cwd(),config.log.path)].forEach(dir=>{if(!fs.existsSync(dir)){fs.mkdirSync(dir)}});let server=new inversify_express_utils_1.InversifyExpressServer(di_container_1.container);server.setConfig(app=>{app.use(bodyParser.urlencoded({extended:true,limit:"50mb"}));app.use(bodyParser.json());app.use(logger.handleExpressLogs.bind(logger));app.use(express.static(path.join(__dirname,"../public")));app.set("views",path.join(__dirname,"../views"));app.set("view engine","pug");app.use(session({store:new SessionStore({db:config.database.path,table:"t_sessions"}),secret:config.sessionScreet,resave:true,saveUninitialized:false,cookie:{maxAge:7*24*60*60*1e3}}));app.use(utils_1.SecurityUtils.checkReqAuth)});let app=server.build();app.use(request_handler_utils_1.RequestHandlerUtils.handle404);app.use(request_handler_utils_1.RequestHandlerUtils.handle500);app.listen(config.server.port);logger.info("Bloglite is running!")}).call(this,"dist")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});class RequestHandlerUtils{static handle404(req,res,next){res.status(404);res.render("404")}static handle500(err,req,res,next){if(res.headersSent){return next(err)}res.status(500);res.render("500")}}exports.RequestHandlerUtils=RequestHandlerUtils},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const inversify_1=__webpack_require__(0);const config_reader_1=__webpack_require__(17);const dashboard_controller_1=__webpack_require__(22);const editor_controller_1=__webpack_require__(24);const login_controller_1=__webpack_require__(25);const post_controller_1=__webpack_require__(26);const rss_controller_1=__webpack_require__(28);const database_1=__webpack_require__(8);const logger_1=__webpack_require__(30);const post_dao_1=__webpack_require__(5);const user_dao_1=__webpack_require__(12);const container=new inversify_1.Container;exports.container=container;container.bind("Config").toConstantValue(config_reader_1.config);container.bind("Logger").toConstantValue(logger_1.LoggerCreator(container));container.bind(database_1.Database).toSelf().inSingletonScope();container.bind(user_dao_1.UserDAO).toSelf().inSingletonScope();container.bind(post_dao_1.PostDAO).toSelf().inSingletonScope();container.bind(login_controller_1.LoginController).toSelf();container.bind(dashboard_controller_1.DashboardController).toSelf();container.bind(editor_controller_1.EditorController).toSelf();container.bind(post_controller_1.PostController).toSelf();container.bind(rss_controller_1.RSSController).toSelf()},function(module,exports,__webpack_require__){"use strict";(function(__dirname){Object.defineProperty(exports,"__esModule",{value:true});const path=__webpack_require__(7);const fs=__webpack_require__(9);const utils_1=__webpack_require__(2);const fetchServerConfig=()=>{const filePath=path.join(__dirname,"../config.json");console.log("Config file's path is "+__dirname);const config=JSON.parse(fs.readFileSync(filePath,"utf8"));utils_1.DateUtils.timezone=config.timezone;utils_1.SecurityUtils.securePath="/"+config.securePath;return config};exports.config=fetchServerConfig()}).call(this,"dist")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});class CommonUtils{static generatePermalink(text){const specialCharDictionary={"ş":"s","ı":"i","ğ":"g","ö":"o","ç":"c","ü":"u"};let permalink=text.toLocaleLowerCase();Object.keys(specialCharDictionary).forEach(key=>{permalink=CommonUtils.replaceAll(permalink,key,specialCharDictionary[key])});permalink=permalink.replace(/\W/g," ").replace(/\s+/g," ").trim().replace(/\s+/g,"-");return permalink}static replaceAll(target,search,replacement){return target.replace(new RegExp(search,"g"),replacement)}}exports.CommonUtils=CommonUtils},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const moment=__webpack_require__(20);class DateUtils{static now(){return moment().tz(DateUtils.timezone)}}exports.DateUtils=DateUtils},function(module,exports){module.exports=require("moment-timezone")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const hallPassAPIs=["login"];class SecurityUtils{static checkReqAuth(req,res,next){if(req.url.indexOf(SecurityUtils.securePath+"/")===0&&!hallPassAPIs.find(path=>req.url.includes(path))&&(!req.session||!req.session.user)){res.redirect(SecurityUtils.securePath);return}next()}}SecurityUtils.securePath="/s";exports.SecurityUtils=SecurityUtils},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};var __param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};Object.defineProperty(exports,"__esModule",{value:true});const post_dao_1=__webpack_require__(5);__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3);const inversify_1=__webpack_require__(0);const express=__webpack_require__(11);const operators_1=__webpack_require__(6);const utils_1=__webpack_require__(2);let DashboardController=class DashboardController{constructor(){this.PAGE_SIZE=10}dashboardPage(page,res){let mPage=0;if(page){mPage=+page-1}return this.postDAO.getPostLiteList(this.PAGE_SIZE,this.PAGE_SIZE*mPage).pipe(operators_1.switchMap(postList=>this.postDAO.getPostCount().pipe(operators_1.map(c=>({totalPage:Math.ceil(c/this.PAGE_SIZE),postList:postList}))))).toPromise().then(r=>{res.render("dashboard",{postList:r.postList,pageNum:mPage+1,totalPage:r.totalPage===0?1:r.totalPage})})}};__decorate([inversify_1.inject(post_dao_1.PostDAO),__metadata("design:type",post_dao_1.PostDAO)],DashboardController.prototype,"postDAO",void 0);__decorate([inversify_express_utils_1.httpGet("/dashboard"),__param(0,inversify_express_utils_1.queryParam("page")),__param(1,inversify_express_utils_1.response()),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],DashboardController.prototype,"dashboardPage",null);DashboardController=__decorate([inversify_express_utils_1.controller(utils_1.SecurityUtils.securePath)],DashboardController);exports.DashboardController=DashboardController},function(module,exports){module.exports=require("sqlite3")},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};var __param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};Object.defineProperty(exports,"__esModule",{value:true});const post_dao_1=__webpack_require__(5);__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3);const inversify_1=__webpack_require__(0);const operators_1=__webpack_require__(6);const utils_1=__webpack_require__(2);const rxjs_1=__webpack_require__(4);let EditorController=class EditorController{editorPage(postId,res){return this.postDAO.getPostById(+postId).pipe(operators_1.map(post=>({post:post}))).toPromise().then(viewModel=>res.render("editor",viewModel))}updatePost(req,res){const resp={retCode:-1};const post=req.body;if(post){return this.postDAO.updatePost(post).toPromise().then(r=>{resp.retCode=0;res.json(resp)})}res.json(resp)}createPost(req,res){const resp={retCode:-1};const post=req.body;if(post){return this.postDAO.createPost(post.title,post.permalink,post.entry,req.session.user.id).toPromise().then(r=>{resp.retCode=0;res.json(resp)})}res.json(resp)}deletePost(req,res){const resp={retCode:-1};const postId=req.body?+req.body.id:null;if(postId){return this.postDAO.deletePostById(postId).toPromise().then(r=>{resp.retCode=0;res.json(resp)})}res.json(resp)}getPermalink(req,res){let permalink=req.body.permalink||"";if(permalink){permalink=utils_1.CommonUtils.generatePermalink(permalink);let counter=0,suffix="";return rxjs_1.Observable.create(observer=>{const checkPermalink=p=>{p+=suffix;this.postDAO.isPermalinkExist(p).subscribe(r=>{if(r){suffix+="-"+counter++;checkPermalink(permalink)}else{observer.next(permalink);observer.complete()}},e=>{observer.error(e);observer.complete()})};checkPermalink(permalink)}).toPromise().then(r=>res.json({retCode:0,retMsg:"Success",permalink:permalink})).catch(err=>res.json({retCode:1,retMsg:"Generating permalink error"}))}return res.json({retCode:-1,retMsg:"Input error"})}};__decorate([inversify_1.inject(post_dao_1.PostDAO),__metadata("design:type",post_dao_1.PostDAO)],EditorController.prototype,"postDAO",void 0);__decorate([inversify_express_utils_1.httpGet("/editor"),__param(0,inversify_express_utils_1.queryParam("post")),__param(1,inversify_express_utils_1.response()),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"editorPage",null);__decorate([inversify_express_utils_1.httpPost("/updatePost"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"updatePost",null);__decorate([inversify_express_utils_1.httpPost("/createPost"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"createPost",null);__decorate([inversify_express_utils_1.httpPost("/deletePost"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"deletePost",null);__decorate([inversify_express_utils_1.httpPost("/getPermalink"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],EditorController.prototype,"getPermalink",null);EditorController=__decorate([inversify_express_utils_1.controller(utils_1.SecurityUtils.securePath)],EditorController);exports.EditorController=EditorController},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};Object.defineProperty(exports,"__esModule",{value:true});const session_utils_1=__webpack_require__(10);const user_dao_1=__webpack_require__(12);__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3);const inversify_1=__webpack_require__(0);const operators_1=__webpack_require__(6);const rxjs_1=__webpack_require__(4);const utils_1=__webpack_require__(2);let LoginController=class LoginController{loginPage(req,res,next){if(req.session.user){res.redirect(utils_1.SecurityUtils.securePath+"/dashboard");return}res.render("login")}authenticate(req,res,next){if(req.body.email){return this.userDAO.getUserByEmail(req.body.email).pipe(operators_1.switchMap(user=>{if(user&&user.password===req.body.password){req.session.user=user;return session_utils_1.SessionUtils.saveSession(req.session)}return rxjs_1.of(false)})).toPromise().then(isSuccess=>{if(isSuccess){res.redirect(utils_1.SecurityUtils.securePath+"/dashboard")}else{res.redirect(utils_1.SecurityUtils.securePath)}})}res.redirect(utils_1.SecurityUtils.securePath)}};__decorate([inversify_1.inject(user_dao_1.UserDAO),__metadata("design:type",user_dao_1.UserDAO)],LoginController.prototype,"userDAO",void 0);__decorate([inversify_express_utils_1.httpGet("/"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object,Function]),__metadata("design:returntype",void 0)],LoginController.prototype,"loginPage",null);__decorate([inversify_express_utils_1.httpPost("/"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object,Function]),__metadata("design:returntype",void 0)],LoginController.prototype,"authenticate",null);LoginController=__decorate([inversify_express_utils_1.controller(utils_1.SecurityUtils.securePath)],LoginController);exports.LoginController=LoginController},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};var __param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};Object.defineProperty(exports,"__esModule",{value:true});const error_404_1=__webpack_require__(27);const operators_1=__webpack_require__(6);const post_dao_1=__webpack_require__(5);__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3);const inversify_1=__webpack_require__(0);const rxjs_1=__webpack_require__(4);let PostController=class PostController{constructor(){this.PAGE_SIZE=10}homePage(page,res){let mPage=0;if(page){mPage=+page-1}return rxjs_1.zip(this.postDAO.getPostList(this.PAGE_SIZE,this.PAGE_SIZE*mPage),this.postDAO.getPostCount()).pipe(operators_1.map(d=>({postList:d[0],totalPage:Math.ceil(d[1]/this.PAGE_SIZE)}))).toPromise().then(r=>{res.render("home",{postList:r.postList,pageNum:mPage+1,totalPage:r.totalPage})})}postPage(permalink,res){return this.postDAO.getPostByPermalink(permalink).pipe(operators_1.map(post=>{if(post){return post}throw new error_404_1.Error404("Page not found")})).toPromise().then(post=>{res.render("post",{post:post})}).catch(err=>{if(err instanceof error_404_1.Error404){res.status(404);res.render("404")}})}};__decorate([inversify_1.inject(post_dao_1.PostDAO),__metadata("design:type",post_dao_1.PostDAO)],PostController.prototype,"postDAO",void 0);__decorate([inversify_express_utils_1.httpGet("/"),__param(0,inversify_express_utils_1.queryParam("page")),__param(1,inversify_express_utils_1.response()),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],PostController.prototype,"homePage",null);__decorate([inversify_express_utils_1.httpGet("p/:permalink"),__param(0,inversify_express_utils_1.requestParam("permalink")),__param(1,inversify_express_utils_1.response()),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],PostController.prototype,"postPage",null);PostController=__decorate([inversify_express_utils_1.controller("/")],PostController);exports.PostController=PostController},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});class Error404 extends Error{constructor(msg){super(msg)}}exports.Error404=Error404},function(module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};Object.defineProperty(exports,"__esModule",{value:true});__webpack_require__(1);const inversify_express_utils_1=__webpack_require__(3);const RSS=__webpack_require__(29);const post_dao_1=__webpack_require__(5);const inversify_1=__webpack_require__(0);let RSSController=class RSSController{rss(req,res){const feed=new RSS({title:"mbakturk.com",description:"Yazılım Mühendisi / Kişisel Blog Sitesi",site_url:this.config.baseUrl,feed_url:this.config.baseUrl+"/rss",language:"tr"});return this.postDAO.getPostList(100,0).toPromise().then(postList=>{postList.forEach(post=>{feed.item({title:post.title,description:this.generateRSSDescription(post.entry),url:`${this.config.baseUrl}/p/${post.permalink}`,date:post.postDate})});res.set("Content-Type","text/xml");res.send(feed.xml({indent:true}))})}generateRSSDescription(text){return text?text.replace(/<\/?[^>]+(>|$)/g," ").substr(0,250).trim()+"...":""}};__decorate([inversify_1.inject(post_dao_1.PostDAO),__metadata("design:type",post_dao_1.PostDAO)],RSSController.prototype,"postDAO",void 0);__decorate([inversify_1.inject("Config"),__metadata("design:type",Object)],RSSController.prototype,"config",void 0);__decorate([inversify_express_utils_1.httpGet("rss"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],RSSController.prototype,"rss",null);RSSController=__decorate([inversify_express_utils_1.controller("/")],RSSController);exports.RSSController=RSSController},function(module,exports){module.exports=require("rss")},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const winston_1=__webpack_require__(31);const path=__webpack_require__(7);const DailyRotateFile=__webpack_require__(32);const utils_1=__webpack_require__(2);const LoggerCreator=container=>{const config=container.get("Config");const logDir=path.join(process.cwd(),config.log.path);const timestamp=winston_1.format((info,opts)=>{info.timestamp=utils_1.DateUtils.now().format("YYYY-MM-DD HH:mm:ss");return info});const logFormat=winston_1.format.combine(timestamp(),winston_1.format.printf(info=>`${info.timestamp} [${info.level}]: ${info.message}`));const errorTransport=new DailyRotateFile({filename:logDir+"error-%DATE%.log",datePattern:"YYYY-MM-DD",maxSize:"20m",level:"error"});const combinedTransport=new DailyRotateFile({filename:logDir+"combined-%DATE%.log",datePattern:"YYYY-MM-DD",maxSize:"20m"});const logger=winston_1.createLogger({level:config.log.level,format:logFormat,transports:[errorTransport,combinedTransport,new winston_1.transports.Console({level:"info"})]});logger.handleExpressLogs=((req,res,next)=>{const ip=req.connection.remoteAddress;logger.debug(`(${ip}) ${req.method} ${req.url} ${res.statusCode}`);next()});return logger};exports.LoggerCreator=LoggerCreator},function(module,exports){module.exports=require("winston")},function(module,exports){module.exports=require("winston-daily-rotate-file")},function(module,exports){module.exports=require("body-parser")},function(module,exports){module.exports=require("express-session")},function(module,exports){module.exports=require("connect-sqlite3")}]);